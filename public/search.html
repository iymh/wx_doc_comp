<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.x/dist/vuetify.min.css" rel="stylesheet">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Function Search</title>
  <style>
    [v-cloak] {
      display: none;
    }
    .wdt2 {
      width: 2rem;
    }
    .wdt5 {
      width: 5rem;
    }
    .wdt10 {
      width: 10rem;
    }
    .wdt12 {
      width: 12rem;
    }
    .ws-preline {
      white-space: pre-line;
    }

    .hide {
      display: none;
    }

    /* for highlight in discovery result. */
    em {
      font-weight: bold;
      color: red;
    }
    .text-gray {
      color: gray !important;
    }
    .text-gray .text-green,
    .text-gray .text-info,
    .text-gray .text-warning {
      color: gray !important;
    }
  </style>
</head>

<body>
  <div id="app" v-cloak>
    <v-app>
      <!-- Toast Component -->
      <v-snackbar
        v-model="toast.show"
        :timeout="toast.timeout"
        :color="toast.type"
        location="bottom"
        @click="toast.show = false">
        <div class="rw">{{ toast.text }}</div>
      </v-snackbar>

      <!-- Discovery Options Dialog -->
      <v-dialog v-model="dc_param_dialog">
        <v-card class="">
          <v-card-title>
            <span class="text-h5">Query Parameters</span>
          </v-card-title>
          <v-card-text class="flex-grow-1">
            <v-textarea
              v-model="dc_paramjson"
              label="Request Params"
              variant="outlined"
              rows="5"
            ></v-textarea>
          </v-card-text>
          <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn color="secondary"
              @click="dc_param_dialog=false">
              Cancel
            </v-btn>
          </v-card-actions>
        </v-card>
      </v-dialog>

      <v-main>
        <v-container>

          <!-- <v-divider></v-divider> -->
          <div class="ma-2">
            <v-row class="justify-center align-center ma-3">
              <v-combobox
                class="flex-grow-1 ma_lr_1rem ma_tp_05rem"
                v-model="dc_inputnlq"
                :items="dc_inputnlq_items"
                label="検索する機能"
                variant="outlined"
                clearable
                counter
                density="compact"
                rows="1"
                ref="nlq_combobox"
                @keydown.enter="handleSearchInput(dc_inputnlq)"
                @blur="handleSearchInput(dc_inputnlq)"
              ></v-combobox>
            </v-row>

            <v-row class="justify-center align-center ma-3">
              <v-select
                label="Collections"
                variant="outlined"
                density="compact"
                :items="dc_collections"
                item-title="name"
                item-value="collection_id"
                v-model="dc_collections_selected"
                return-object
                hide-details
                class="mr-4"
              ></v-select>
                <!-- multiple -->

              <div class="wdt12 mr-4">
                <div class="text-caption">検索一致度閾値</div>
                <v-slider
                  v-model="confidenceThreshold"
                  min="0"
                  max="100"
                  step="1"
                  hide-details
                  density="compact"
                  thumb-label
                >
                  <template v-slot:thumb-label="{ modelValue }">
                    {{ modelValue }}%
                  </template>
                </v-slider>
              </div>

              <v-btn 
                color="primary"
                icon elevation="1"
                :disabled="!dc_inputnlq || dc_inputnlq.length === 0"
                @click="sendQuery()">
                <v-icon>mdi-card-search-outline</v-icon>
              </v-btn>

              <v-btn color="primary"
                icon elevation="1"
                @click="dc_param_dialog=true">
                <v-icon>mdi-code-json</v-icon>
              </v-btn>

            </v-row>
          </div>

          <!-- <v-divider></v-divider> -->
          <v-row class="justify-space-between align-center" style="background-color: lavender">
            <div class="ma-2 text-h5 text-primary">AI検索結果:</div>
            <v-btn 
              class="ma-2"
              color="warning"
              icon elevation="1"
              :loading="llmLoading"
              :disabled="!dc_outputjsons || dc_outputjsons.length === 0"
              @click="onSendAIJudgeBtn()">
              <v-icon>mdi-robot</v-icon>
            </v-btn>
          </v-row>
          <v-row class="justify-center">
            <div class="flex-grow-1">
                <v-data-table
                  :items="dc_outputjsons"
                  :loading="dc_tbl_loading"
                  disable-pagination
                  disable-sort
                  :items-per-page="100"
                  no-data-text="データがありません"
                  hide-default-header
                  hide-default-footer
                >
                  <template v-slot:item="{ item }">
                    <div class="ma-2 elevation-3" :class="{ 'bg-grey-lighten-1': getItemConfidence(item) < (confidenceThreshold / 100) }">
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-green">検索一致度</div>
                        <div class="flex-grow-1" v-if="getItemConfidence(item) > 0">{{ Number((getItemConfidence(item) * 100).toFixed(3)) }}%</div>
                        <div class="flex-grow-1" v-else>-</div>
                      </div>
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-info">カテゴリ</div>
                        <div class="flex-grow-1" v-if="item.カテゴリ">{{ item.カテゴリ }}</div>
                      </div>
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-info">要件</div>
                        <div class="flex-grow-1" v-if="item.要件">{{ item.要件 }}</div>
                      </div>
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-info">回答</div>
                        <div class="flex-grow-1" v-if="item.回答">{{ item.回答 }}</div>
                      </div>
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-info">備考／補足</div>
                        <div class="flex-grow-1" v-if="item['備考／補足']">{{ item['備考／補足'] }}</div>
                      </div>
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-info">変更区分</div>
                        <div class="flex-grow-1" v-if="item.変更区分">{{ item.変更区分 }}</div>
                      </div>
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-info">意見</div>
                        <div class="flex-grow-1" v-if="item.意見">{{ item.意見 }}</div>
                      </div>
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-info">変更後要件</div>
                        <div class="flex-grow-1" v-if="item.変更後要件">{{ item.変更後要件 }}</div>
                      </div>
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-info">Sier向けコメント</div>
                        <div class="flex-grow-1" v-if="item.Sier向けコメント">{{ item.Sier向けコメント }}</div>
                      </div>
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-info">工数</div>
                        <div class="flex-grow-1" v-if="item.工数">{{ item.工数 }}</div>
                      </div>
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-info">社内向けコメント</div>
                        <div class="flex-grow-1" v-if="item.社内向けコメント">{{ item.社内向けコメント }}</div>
                      </div>

                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-info">ファイル名</div>
                        <div class="flex-grow-1" v-if="item.ファイル名">{{ item.ファイル名 }}</div>
                      </div>
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-info">シート名</div>
                        <div class="flex-grow-1" v-if="item.シート名">{{ item.シート名 }}</div>
                      </div>
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-info">行番号</div>
                        <div class="flex-grow-1" v-if="item.行番号">{{ item.行番号 }}</div>
                      </div>

                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-warning">AI判定</div>
                        <div class="flex-grow-1" v-if="item.ai_result && item.ai_result.judge">{{ item.ai_result.judge }}</div>
                      </div>
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-warning">AIスコア</div>
                        <div class="flex-grow-1" v-if="item.ai_result && item.ai_result.score">{{ item.ai_result.score }}</div>
                      </div>
                      <div class="d-flex align-center elevation-1">
                        <div class="wdt10 text-warning">AI理由</div>
                        <div class="flex-grow-1" v-if="item.ai_result && item.ai_result.reason">{{ item.ai_result.reason }}</div>
                      </div>

                    </div>
                  </template>
                </v-data-table>
            </div>
          </v-row>

        </v-container>
      </v-main>
    </v-app>
  </div>

  <script type="importmap">
  {
    "imports": {
      "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
      "vuetify": "https://unpkg.com/vuetify@3/dist/vuetify.esm.js"
    }
  }
  </script>

  <script type="module">
    // WatsonAPIsクラスを外部モジュールからインポート
    import { WatsonAPIs } from './watson-exec.js';

    import { createApp } from 'vue';
    import { createVuetify, components, directives } from 'vuetify';

    const vuetify = createVuetify({
      components,
      directives
    });

    const app = createApp({
      data() {
        // WatsonAPIsのインスタンスを作成
        const watsonAPIs = new WatsonAPIs();

        return {
          // --- サービスインスタンス ---
          watsonAPIs: watsonAPIs,

          // --- コンポーネントの状態 ---
          toast:{ show: false, timeout: 5000, type: "primary", text:"" },
          dc_param_dialog: false,
          dc_tbl_loading: false,
          llmLoading: false,
          debounceTimer: null, // デバウンス処理用のタイマー

          // --- UIと連動するデータ ---
          dc_paramjson: JSON.stringify(watsonAPIs.defaultDiscoveryParams, null, 2),
          dc_collections: [],
          dc_collections_selected: [],
          dc_inputnlq: "",
          dc_inputnlq_items:[],
          dc_outputjsons: [],
          wx_result: {},
          confidenceThreshold: 0.0,
        }
      },

      watch: {
        dc_collections_selected: function(cid) {
          let param = JSON.parse(this.dc_paramjson);

          // enable multiple collections
          //param.collection_ids = cids.map(c => c.collection_id);
          param.collection_ids = [cid.collection_id]
          
          this.dc_paramjson = JSON.stringify(param, null, 2);
        },
      },

      methods: {
        handleSearchInput(searchInput) {
          // searchInputがnullの場合（クリアボタン押下時など）を考慮
          const newQuery = searchInput || '';

          // 既存のタイマーをクリア
          clearTimeout(this.debounceTimer);

          this.dc_inputnlq = newQuery;

          // 入力値がある場合のみタイマーを設定
          if (newQuery) {
            this.debounceTimer = setTimeout(() => {
              this.sendAutoComp();
            }, 500); // 500ミリ秒後に入力値が変更されなければsendAutoCompを実行
          }
        },

        showToast(msg) {
          this.toast.text = msg;
          this.toast.show = true;
        },

        async listCollections(showtoast) {
          const collections = await this.watsonAPIs.fetchCollections();
          if (collections) {
            this.dc_collections = collections;
            if (showtoast) this.showToast("コレクションの取得が完了しました");
          } else {
            this.dc_collections = [];
            if (showtoast) this.showToast("コレクションの取得が失敗しました");
          }
        },

        async sendQuery(showtoast) {
          let currentParams;
          try {
            currentParams = JSON.parse(this.dc_paramjson);
          } catch(err) {
            console.error("JSONパース失敗:", err);
            this.showToast("Query ParametersのJSON形式が正しくありません。");
            return;
          }
          this.dc_tbl_loading = true;
          try {
            const resultJson = await this.watsonAPIs.executeQuery(this.dc_inputnlq, currentParams);
            console.log(resultJson);
            if (resultJson) {
              this.setResultTable(resultJson);
              if (showtoast) this.showToast("データの取得が完了しました");
            } else {
              if (showtoast) this.showToast("データの取得が失敗しました");
            }
          } finally {
            this.dc_tbl_loading = false;
          }
        },

        async sendAutoComp() {
          let currentParams;
          try {
            currentParams = JSON.parse(this.dc_paramjson);
          } catch(err) {
            console.error("JSONパース失敗:", err);
            this.showToast("AutoComplete ParametersのJSON形式が正しくありません。");
            return;
          }

          try {
            const resultJson = await this.watsonAPIs.executeAutocomp(this.dc_inputnlq, currentParams);
            if (resultJson && resultJson.completions) {
              this.dc_inputnlq_items = resultJson.completions;
            }
          } finally {
            // 処理完了
          }
        },

        setResultTable(json) {
          this.dc_outputjsons = (json && json.results) ? json.results : [];
        },

        async onSendAIJudgeBtn() {
          this.llmLoading = true;
          try {
            await this.watsonAPIs.processAIJudgements(
              this.dc_outputjsons,
              this.dc_inputnlq,
              (index, updatedItem) => { // onProgressコールバック
                // Vue 3ではreactivity APIを使用するか、直接配列を操作します
                this.dc_outputjsons[index] = updatedItem;
              }
            );
            this.showToast("AIによる判定が完了しました。");
          } catch (err) {
            console.error("AI判定エラー:", err);
            this.showToast("AI判定中にエラーが発生しました。");
          } finally {
            this.llmLoading = false;
          }
        },
        
        getItemConfidence(item) {
          if (item.document_passages && 
              item.document_passages.length > 0 && 
              item.document_passages[0].answers && 
              item.document_passages[0].answers.length > 0) {
            return item.document_passages[0].answers[0].confidence;
          }
          return 0;
        },

        async init() {
          await this.listCollections();
          this.dc_collections_selected = this.dc_collections[0];
          this.dc_inputnlq = this.dc_inputnlq_items[0];
        }
      },

      mounted() {
        this.init();
      }
    });

    // Vuetifyの使用
    app.use(vuetify);
    
    // アプリケーションのマウント
    app.mount('#app');
  </script>
</body>
</html>
